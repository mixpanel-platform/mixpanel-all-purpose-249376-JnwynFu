<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="md5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ractive/0.7.3/ractive.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div id="container"></div>

    <!-- What am I doing here:

    - build a group of radio buttons to select between spec creators (a modicum of version control)
    - select the most recently created spec by default
      - currently the setting of 'checked' isn't being respected, not sure why
    - for a selected user, show their spec as a table of event name - event properties

    Still to add
    - a toggle to make all items editable as inputs
      - see the dbl_click behavior of this example http://examples.ractivejs.org/todos
    -->
    <script type="text/ractive" id="template">

      {{#if token == ""}}
        <div>
          <form on-submit="setToken( event, {token: initialToken, author: author} )">
            <table>
              <tr>
                <td>
                  Enter your project token:
                </td>
                <td>
                  <div><input type="text" value="{{initialToken}}" placeholder="From your Account settings page"></div>
                </td>
              </tr>
              <div><p>Hint: this project's token is 8950dac216646efa64092d982b5403ba</p></div>
              <tr>
                <td>
                  And your name:
                </td>
                <td>
                  <label><input type="text" value="{{author}}" placeholder="Satchmo B Helpful"></label>
                </td>
              </tr>
            </table>
            <input type="submit" value="Create a Spec">
          </form>
        </div>

      {{else}}
        <fieldset>
          {{#if author === ""}}
          <div>
            <form id="getAuthor" on-submit="newSpec( event, inputAuthor )">
              <input type="text" value="{{inputAuthor}}" lazy>
              <input type="submit">
            </form>
          </div>
          {{else}}
            {{#each spec}}
            <div><input type='radio' name="{{selectedUser}}" value="{{user}}" {{#if selectedUser == user}}checked{{/if}}>{{user}}</div>
            {{/each}}
            <p>The selected user&apos;s spec is {{selectedUser}}.</p>
          {{/if}}
        </fieldset>

        <fieldset>
          <label><input type="radio" name="{{edit}}" value="{{false}}">Check Mode</label>
          <label><input type="radio" name="{{edit}}" value="{{true}}">Edit Mode</label>
        </fieldset>
        <p> currently in edit mode? {{edit}}

        {{> selectedSpecTemplate}}
      {{/if}}
    </script>

    <script id="selectedSpecTemplate" type="text/ractive">
      {{#with authorSpec}}
      <table>
        <thead>
          <tr>
            <th>Events</th>
            <th>Properties</th>
          </tr>
        </thead>
        {{#if edit}}
        <tr>
          <td>
              <div><input type="text" value="{{newEvent.name}}" placeholder="new event name"></div>
              <div><input type="button" on-click="addNewEvent"  value="add to spec"></div>
          </td>
          <td>
            <form id="propInput" on-submit="addNewProp( event, newProp )">
              <div><label><input type="text" value="{{newProp}}" placeholder="property"></label></div>
              {{#each newEvent.properties}}
              <div><input type="text" value="{{.}}" placeholder="property"></div>
              {{/each}}
              <label><input type="submit"></label>
            </form>
          </td>
        </tr>
        {{/if}}
        {{#each .events}}
        <tr>
          <td>
            {{.name}}
          </td>
          <td>
          {{#each .properties}}
            <div>{{.}}</div>
          {{/each}}
          </td>
        </tr>
        {{/each}}
      </table>
      {{/with}}
    </script>

    <script>
    // sample spec for testing
    //
    // eventually this will be the return of an api export call
      var completeSpec = [
      {
        "events":
          [
            {
              "name":"Landing",
              "properties":["browser","flavor"]
            },
            {
              "name":"Login",
              "properties":["auth","region"]
            }
          ],
        "timestamp":"2015-04-29T20:26:20",
        "user":"steve"
      },
      {
        "events":
          [
            {
              "name":"Not Landing",
              "properties":["bowser","mario"]
            }
          ],
        "timestamp":"2015-04-29T20:26:20",
        "user":"joe"
      }];
      
      //make a Ractive object
      var ractive = new Ractive({
        el: "#container",
        template: "#template",
        data: { spec: [], token: "", selectedUser: "", author: "", edit: false, newEvent: { name: "", properties: [] }, newProp: "" },
        newSpec: function( event, author ) {
          event.original.preventDefault();
          ractive.set( 'author', author );
          console.log('author', author);
          console.log('authorSpec', ractive.get('authorSpec'));
          if (!ractive.get('authorSpec')) {
            console.log('newSpec');
            ractive.push('spec', {
              'user': author,
              'events': [],
              'timestamp': new Date(),
            });
          }
          ractive.set( 'selectedUser', author );
          localStorage.setItem( 'author', author );
        },
        setToken: function( event, info ) {
          event.original.preventDefault();
          this.set( 'spec', [ { 'user': info.author, 'timestamp': new Date(), 'events': [] } ] );
          set(
            data = { 'token': info.token, 'spec': ractive.get('spec') },
            token = info.token
          );
          this.newSpec( event, info.author );
          console.log('get', ractive.get('token'), ractive.get('spec'))
          ractive.set( 'token', info.token );
          ractive.set( 'selectedUser', info.author );
          initialize ( info.token, ractive.get('spec'));
          ractive.set('edit', true);
        },
        addNewEvent: function ( eventObj ) {
          ractive.get( 'authorSpec.events' ).push({
            'name': eventObj.name,
            'properties': eventObj.properties
          });
          ractive.set('newEvent', { name: "", properties: [] });
        },
        addNewProp: function( event, prop ) {
          event.original.preventDefault();
          ractive.push('newEvent.properties', prop);
          ractive.set('newProp', "");
        },  
        filters: {
          user: function ( specItem ) { return specItem.user === ractive.get('selectedUser') },
          author: function( specItem ) { return specItem.user === ractive.get('author') }
        },
        computed: {
          selectedSpec: function () {
            return ractive.get( 'spec' ).filter(ractive.filters.user)[0];
          },
          authorSpec: function() {
            return ractive.get( 'spec' ).filter(ractive.filters.author)[0];
          }
        }
      })

      ractive.on( 'addNewEvent', function ( event ) {
        event.original.preventDefault();
        console.log('this', this.get);
        this.addNewEvent( ractive.get( 'newEvent' ) );
      })

      try {
        localStorage = window.localStorage;
      } catch (err) {}

      var author = ''
      if (localStorage) {
        author = localStorage.getItem('author') || ''
      }

      ractive.set('author', author);
      ractive.set('selectedUser', author);
      
      var proto = document.location.protocol;
      var setUrl = proto + "//api.mixpanel.com/engage";
      var getUrl = proto + "//mixpanel.com/api/2.0/engage";

      var distinct = "SPEC_USER11";

      //A user must first input this project's token which will create the profile/database
      //setToken = function(projectToken) {
      //  token = $('input:text[name=token]').val();
      //  set({'token': projectToken})
      //}

      //pass this a list of spec objects
      set = function(data, token) {
        update = {
          "$token": token,
          "$distinct_id": distinct,
          "$set": data,
          "$ignore_time": true
        }

        payload = { 'data': btoa(JSON.stringify(update)), "ip": 0 };

        console.log('set', payload)
        setXHR = new XMLHttpRequest();
        setXHR.open("POST", setUrl, true);
        setXHR.send($.param(payload))
      };

      //retrieve the user/database
      get = function() {
        var params = {
          'distinct_id': distinct,
          'expire': Math.round(new Date() / 1000) + 600,
          'api_key': MP.api.apiKey
        }

        var keys = Object.keys(params).sort();
        var sig = keys.map(function(key) {
            return "" + key + "=" + (params[key]);
        }).join("") + MP.api.apiSecret;
                        
        params.sig = md5(sig);

        return $.ajax(getUrl + '?' + $.param(params))
      }

      initialize = function(token, spec) {
        token = (typeof token !== 'undefined') ? token : "";
        spec = (typeof spec !== 'undefined') ? spec : []
        // initiate some spinning wheel thing saying that
        // Your Data is Loading

        // load a spec if it exists
        get().done(function(data){
          info = data.results[0]
          console.log('info', info)
          if (info) {
            ractive.set('spec', info.$properties.spec);
            ractive.set('selectedUser', info.$properties.spec[0].user);
            //spec = completeSpec;
            ractive.set('token', info.$properties.token);
          } 
        });
      }
 
      //initial page creation
      MP.api.on('mpplatform.credentialsRegistered', initialize())

      //for local testing
      //MP.api.trigger('mpplatform.credentialsRegistered');

    </script>
  </body>
</html>
