<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="md5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ractive/0.7.3/ractive.min.js"></script>
  </head>
<style type="text/css">

h1 {
  font-size:22px;
  color:#747d94;
  text-align:center;
  padding:10px 0 10px 0;
}

span.date {
  color:black;
  padding-top: 10px;
  display:block;
}

span.edit {
  color:black;
}

.left {
  float:left;
  clear:both;
}

.clear {
  clear:both;
}

.right {
  float:right;
}

.center {
  text-align:center;
}

.notice {
  font-size:13px;
  color:#747d94;
  text-align:center;
  margin:10px auto 20px auto;
  padding:0 40px 0 40px;
}

.formWrapper {
  width:150px;
  padding:10px;
}

.event {
 padding:10px;
 border: 1px solid black;
}

.eventName {
  font-size: 14px;
  color:#747d94;
  font-weight:800;
  text-align: center;
  padding:10px;
  float:left;
  width:40%;
}

.propertyName {
  font-size: 14px;
  color:#747d94;
  text-align: center;
  padding:1px;
  float:right;
  width:40%;
  clear:both;
}

#newEvent {
  color:#747d94;
  border-radius:5px;
  font-weight:bold;
  padding:15px;
  text-transform:uppercase;
  width:100%;
  text-align: center;
  width:360px;
}

#newEvent {

}

#specItems {
padding:10px;
margin:5px;
width:250px;
}

.specItem {
  display:inline-block;
  width:100%;
  border: 1px grey solid; 
}

#container {
  width:680px;
}

#specTemplate {
  float: left;
  width: 70%;
}

#rightNav {
  float:right;
}

#spec {
  float:left;
  
}

#controls {
  box-shadow:0 1px 2px 0 rgba(0,0,0,0.1);
  float:right;
  position: relative;
  /*bottom: 50px;*/
  color:#747d94;
  border-radius:5px;
  font-weight:bold;
  padding:15px;
  background-color:#f9fafb;
  text-transform:uppercase;
  border:1px solid #cbcfd9;
  width:240px;
  text-align: center;
}

</style>
  <body class="mixpanel-platform-body">

    <div id="container"></div>

    <!-- What am I doing here:

    - build a group of radio buttons to select between spec creators (a modicum of version control)
    - select the most recently created spec by default
      - currently the setting of 'checked' isn't being respected, not sure why
    - for a selected user, show their spec as a table of event name - event properties

    Still to add
    - a toggle to make all items editable as inputs
      - see the dbl_click behavior of this example http://examples.ractivejs.org/todos
    -->
    <script type="text/ractive" id="template">
      {{#if token == ""}}
      <div>
        <form on-submit="setToken( event, {token: initialToken, author: author} )">
          <table>
            <tr>
              <td>
                Enter your project token:
              </td>
              <td>
                <div><input type="text" value="{{initialToken}}" placeholder="From your Account settings page"></div>
              </td>
            </tr>
            <div><p>Hint: this projects token is 8950dac216646efa64092d982b5403ba</p></div>
            <tr>
              <td>
                And your name:
              </td>
              <td>
                <label><input type="text" value="{{author}}" placeholder="Satchmo B Helpful"></label>
              </td>
            </tr>
          </table>
          <input type="submit" value="Create a Spec">
        </form>
      </div>
      {{else}}
      
        {{> specTemplate}}

      {{/if}}

      {{> rightNav}}
    </script>

    <script id="rightNav" type="text/ractive">
      <div id="controls">
        <select value="{{workingSpec}}">
          {{#each allSpecs}}
          <option>{{.timestamp}}</option>
          {{/each}}
        </select>
        {{#if author === ""}}
        <div>
          <input type="text" value="{{inputAuthor}}" lazy>
          <input type="button" on-click="newSpec( inputAuthor )" value="Save">>
        </div>
        {{/if}}
        <p>The selected spec was created on <span class="date">{{workingSpec.timestamp}}.</span></p>

        <fieldset>
          <label><input type="radio" name="{{edit}}" value="{{false}}">Check Mode</label>
          <label><input type="radio" name="{{edit}}" value="{{true}}">Edit Mode</label>
        </fieldset>
        <p> currently in edit mode? <span class="edit">{{edit}}</span>
      </div>
    </script>

    <script id="specTemplate" type="text/ractive">
      <div id="spec">
        {{#with workingSpec}}
      
        {{#if edit}}{{> newEvent}}{{/if}}

      <div id="specItems">
        {{#each .events:i}}
          <div class="specItem">
              <div class="eventName">{{.name}}</div>
                {{#each .properties}}
              <div class="propertyName">{{.}}</div>
            {{/each}}
          </div>
        {{/each}}
        </div>
        {{/with}}
      </div>
    </script>

    <script id="newEvent" type="text/ractive">
      <div id="newEvent">
        <div class="formWrapper left clear">
          <div class="formTitle center">
            Events
          </div>
          <input class="" type="text" value="{{newEvent.name}}" placeholder="Event name">
          <input class="" type="button" on-click="addNewEvent"  value="add to spec">
        </div>

        <div class="formWrapper right">
          <div class="formTitle center">
            Properties
          </div>
          <label><input class="" type="text" value="{{newProp}}" placeholder="property"></label>
          {{#each newEvent.properties}}
            <input class="" type="text" value="{{.}}" placeholder="property">
          {{/each}}
          <input class="" type="button" value="add property" on-click="addNewProp(newProp)">
        </div>
      </div>
    </script>

    <script>
    // sample spec for testing
    //
    // eventually this will be the return of an api export call
      var completeSpec = [
      {
        "events":
          [
            {
              "name":"Landing",
              "properties":["browser","flavor"]
            },
            {
              "name":"Login",
              "properties":["auth","region"]
            }
          ],
        "timestamp":"2015-04-29T20:26:20",
        "user":"steve"
      },
      {
        "events":
          [
            {
              "name":"Not Landing",
              "properties":["bowser","mario"]
            }
          ],
        "timestamp":"2015-04-29T20:26:20",
        "user":"joe"
      }];
      
      //make a Ractive object
      var ractive = new Ractive({
        el: "#container",
        template: "#template",
        data: { allSpecs: [], token: "", workingSpec: {}, author: "", edit: false, newEvent: { name: "", properties: [] }, newProp: "" },
        newSpec: function( event, author ) {
          event.original.preventDefault();
          ractive.set( 'author', author );
          console.log('author', author);
          console.log('authorSpec', ractive.get('authorSpec'));
          if (!ractive.get('authorSpec')) {
            console.log('newSpec');
            ractive.push('spec', {
              'user': author,
              'events': [],
              'timestamp': new Date(),
            });
          }
          ractive.set( 'selectedUser', author );
          localStorage.setItem( 'author', author );
        },
        setToken: function( event, info ) {
          event.original.preventDefault();
          this.set( 'spec', [ { 'user': info.author, 'timestamp': new Date(), 'events': [] } ] );
          set(
            data = { 'token': info.token, 'spec': ractive.get('spec') },
            token = info.token
          );
          this.newSpec( event, info.author );
          console.log('get', ractive.get('token'), ractive.get('spec'))
          ractive.set( 'token', info.token );
          ractive.set( 'selectedUser', info.author );
          initialize ( info.token, ractive.get('spec'));
          ractive.set('edit', true);
        },
        addNewEvent: function ( eventObj ) {
          console.log('new event', eventObj);
          console.log('eventObj', eventObj.name, eventObj.properties)
          ractive.push( 'workingSpec.events', eventObj );
          console.log('pushed')
          ractive.set('newEvent', { name: "", properties: [] });
        },
        addNewProp: function( prop ) {
          console.log('new prop', prop);
          ractive.push( 'newEvent.properties', prop);
          ractive.set( 'newProp', "" );
        },  
        filters: {
          user: function ( specItem ) { return specItem.user === ractive.get('selectedUser') },
          author: function( specItem ) { return specItem.user === ractive.get('author') }
        },
        computed: {
          selectedSpec: function () {
            return ractive.get( 'spec' ).filter(ractive.filters.user)[0];
          },
          authorSpec: function() {
            return ractive.get( 'spec' ).filter(ractive.filters.author)[0];
          }
        }
      })

      ractive.on( 'addNewEvent', function ( event ) {
        event.original.preventDefault();
        console.log('this', this);
        this.addNewEvent( ractive.get( 'newEvent' ) );
      })

      try {
        localStorage = window.localStorage;
      } catch (err) {}

      var author = ''
      if (localStorage) {
        author = localStorage.getItem('author') || ''
      }

      ractive.set('author', author);
      ractive.set('selectedUser', author);
      
      var proto = document.location.protocol;
      var setUrl = proto + "//api.mixpanel.com/engage";
      var getUrl = proto + "//mixpanel.com/api/2.0/engage";

      var distinct = "SPEC_USER13";

      //A user must first input this project's token which will create the profile/database
      //setToken = function(projectToken) {
      //  token = $('input:text[name=token]').val();
      //  set({'token': projectToken})
      //}

      //pass this a list of spec objects
      set = function(data, token) {
        update = {
          "$token": token,
          "$distinct_id": distinct,
          "$set": data,
          "$ignore_time": true
        }

        payload = { 'data': btoa(JSON.stringify(update)), "ip": 0 };

        console.log('set', payload)
        setXHR = new XMLHttpRequest();
        setXHR.open("POST", setUrl, true);
        setXHR.send($.param(payload))
      };

      //retrieve the user/database
      get = function() {
        var params = {
          'distinct_id': distinct,
          'expire': Math.round(new Date() / 1000) + 600,
          'api_key': MP.api.apiKey
        }

        var keys = Object.keys(params).sort();
        var sig = keys.map(function(key) {
            return "" + key + "=" + (params[key]);
        }).join("") + MP.api.apiSecret;
                        
        params.sig = md5(sig);

        return $.ajax(getUrl + '?' + $.param(params))
      }

      initialize = function(token, spec) {
        token = (typeof token !== 'undefined') ? token : "";
        spec = (typeof spec !== 'undefined') ? spec : []
        // initiate some spinning wheel thing saying that
        // Your Data is Loading

        // load a spec if it exists
        get().done(function(data){
          info = data.results[0]
          console.log('info', info)
          if (info) {
            returnedSpec = info.$properties.spec
            returnedSpec.sort(function(a,b){
              return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
            });
            ractive.set('allSpecs', returnedSpec);
            ractive.set('selectedUser', returnedSpec[0].user);
            //spec = completeSpec;
            ractive.set('token', info.$properties.token);
            ractive.set('workingSpec', returnedSpec[0]);
          } 
        });
      }
 
      //initial page creation
      MP.api.on('mpplatform.credentialsRegistered', initialize())

      //for local testing
      //MP.api.trigger('mpplatform.credentialsRegistered');

    </script>

  </body>
</html>
