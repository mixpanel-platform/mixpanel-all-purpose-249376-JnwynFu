<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="md5.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <h1>Hello, World!</h1>
    <script>
      var proto = document.location.protocol;
      var setUrl = proto + "//api.mixpanel.com/engage";
      var getUrl = proto + "//mixpanel.com/api/2.0/engage";

      token = new String();
      spec = []
      var distinct = "SPEC_USER";

      //A user must first input this project's token which will create the profile/database
      setToken = function() {
        token = $('input:text[name=token]').val();
        set({'token':token})
      }

      //pass this a list of spec objects
      set = function(data) {
        update = {
          "$token": token,
          "$distinct_id": distinct,
          "$set": data,
          "$ignore_time": true
        }

        payload = { 'data': btoa(JSON.stringify(update)), "ip": 0 };

        setXHR = new XMLHttpRequest();
        setXHR.open("POST", setUrl, true);
        setXHR.send($.param(payload));
      };

      //retrieve the user/database
      get = function() {
        var params = {
          'distinct_id': distinct,
          'expire': Math.round(new Date() / 1000) + 60,
          'api_key': MP.api.apiKey
        }

        var keys = Object.keys(params).sort();
        var sig = keys.map(function(key) {
            return "" + key + "=" + (params[key]);
        }).join("") + MP.api.apiSecret;
                        
        params.sig = md5(sig);

        return $.ajax(getUrl + '?' + $.param(params))
      }

      //initial page creation
      get().done(function(data){
        spec = data.results[0] 
        //if no user yet, display token entrance box
        if (!spec) {
          var inputbox = '<form id="input">' +
                            'Project Token <input type="text" name="token">' +
                            '<input type="button" value="Initialize" onclick="setToken();">' +
                          '</form>'

          $('body').html(inputbox)
        }
        //else display Check or Edit mode
        else {
          token = spec.$properties.token
          renderCheckMode();
        }
      });

      renderCheckMode = function() {
        //make a page to check the spec

        //a table of events in the spec
        //a table of events NOT in the spec
        console.log('this is the hard part');
      }

      renderEditMode = function() {
        //make a page for inputs
      }

    </script>
  </body>
</html>
