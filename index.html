<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ractive/0.7.3/ractive.min.js"></script>
  </head>
<style type="text/css">
#container {
  width: 680px;
}

#spec {
  float: left;
  width: 70%;
}

#controls {
  float: right;
}

</style>
  <body class="mixpanel-platform-body">
    <div id="container"></div>

    <!-- What am I doing here:

    - build a group of radio buttons to select between spec creators (a modicum of version control)
    - select the most recently created spec by default
      - currently the setting of 'checked' isn't being respected, not sure why
    - for a selected user, show their spec as a table of event name - event properties

    Still to add
    - a toggle to make all items editable as inputs
      - see the dbl_click behavior of this example http://examples.ractivejs.org/todos
    -->
    <script type="text/ractive" id="template">
      {{#if token == ""}}
        {{> initialize}}
      {{else}} 
        {{> specTemplate}}
        {{> rightNav}}
      {{/if}}
    </script>

    <script id="initialize" type="text/ractive">
      <div>
          <table>
            <tr><td>
              Enter your project token:
            </td><td>
              <div><input type="text" value="{{initialToken}}" placeholder="From your Account settings page"></div>
            </td></tr>
            <div><p>Hint: this project's token is 8950dac216646efa64092d982b5403ba</p></div>
            <tr><td>
              And your name:
            </td><td>
              <label><input type="text" value="{{author}}" placeholder="Satchmo B Helpful"></label>
            </td></tr>
          </table>
          <input type="button" value="Create a Spec" on-click="setToken(initialToken)">
      </div>
    </script>

    <script id="rightNav" type="text/ractive">
      <div id="controls">
        {{#if !workingSpec.length}}
          {{newSpec}}
        {{/if}}
        <select value="{{workingSpec}}">
          {{#each allSpecs}}
          <option value="{{this}}">{{ formattedSpecName( this ) }}</option>
          {{/each}}
        </select>
        {{#if author === ""}}
        <div>
          <input type="text" value="{{inputAuthor}}" lazy>
          <input type="button" on-click="newSpec( inputAuthor )" value="Save">>
        </div>
        {{/if}}
        <p>The selected spec was created on {{workingSpec.timestamp}}.</p>

        <fieldset>
          <label><input type="radio" name="{{edit}}" value="{{false}}">Check Mode</label>
          <label><input type="radio" name="{{edit}}" value="{{true}}">Edit Mode</label>
        </fieldset>
        <p> currently in edit mode? {{edit}}</p>
        {{#if edit}}<input type="button" value="Save your spec" on-click="saveSpec()">{{/if}}
      </div>
    </script>

    <script id="specTemplate" type="text/ractive">
      <div id="spec">
        {{#with workingSpec}}
        <table>
          <thead>
            <tr>
              <th>Events</th>
              <th>Properties</th>
            </tr>
          </thead>
          {{#if edit}}{{> newEvent}}{{/if}}
          {{#each .events:i}}
          <tr>
            <td>
              {{.name}}
            </td>
            <td>
            {{#each .properties}}
              <div>{{.}}</div>
            {{/each}}
            </td>
          </tr>
          {{/each}}
        </table>
        {{/with}}
      </div>
    </script>

    <script id="newEvent" type="text/ractive">
      <tr>
        <td>
            <div><input type="text" value="{{newEvent.name}}" placeholder="new event name"></div>
            <div><input type="button" on-click="addNewEvent( newEvent )" value="add to spec"></div>
        </td>
        <td>
          <div><label><input type="text" value="{{newProp}}" placeholder="property" on-change="addNewProp(newProp)"></label></div>
          {{#each newEvent.properties}}
          <div><input type="text" value="{{.}}" placeholder="property"></div>
          {{/each}}
          <input type="button" value="add property" on-click="addNewProp(newProp)">
        </td>
      </tr>
    </script>

    <script>
    // sample spec for testing
    //
    // eventually this will be the return of an api export call
      var completeSpec = [
      {
        "events":
          [
            {
              "name":"Landing",
              "properties":["browser","flavor"]
            },
            {
              "name":"Login",
              "properties":["auth","region"]
            }
          ],
        "timestamp":"2015-04-29T20:26:20",
        "user":"steve"
      },
      {
        "events":
          [
            {
              "name":"Not Landing",
              "properties":["bowser","mario"]
            }
          ],
        "timestamp":"2015-04-29T20:26:20",
        "user":"joe"
      }];
      
      //make a Ractive object
      var ractive = new Ractive({
        el: "#container",
        template: "#template",
        data: {
          allSpecs: [],
          token: "",
          workingSpec: {},
          author: "",
          edit: false,
          newEvent: { name: "", properties: [] },
          newProp: "",
          formattedSpecName: function ( specItem ) {
            return moment(specItem.timestamp).format("MMMM Do @ h:mm") + " by " + specItem.user
          }
        },
        newSpec: function( author ) {
          console.log('current author before set', this.get('author'));
          ractive.set( 'author', author );
          localStorage.setItem( 'author', author );
          ractive.set('edit', true);
          workingSpec = {
            'user': author,
            'timestamp': new Date(),
            'events': [] 
            }
          return Promise.all([
            this.set( 'workingSpec', workingSpec ),
            this.push( 'allSpecs', workingSpec )
          ])
        },
        setToken: function( token ) {
          set(
            data = { 'token': token },
            token = token
          ); // add token to the user
          this.newSpec( this.get( 'author' )).then(function() {
            setTimeout(function() { 
              console.log('timeout complete'); initialize()
            }, 2000);
          });
        },
        saveSpec: function() {
          console.log('saving', this.get( 'workingSpec' ) );
          newSpec = $.extend(this.get( 'workingSpec' ), { 'timestamp': new Date() } );
          append(
            data = { 'spec': newSpec },
            token = this.get( 'token' )
          );
          ractive.push( 'allSpecs', newSpec );
        },
        addNewEvent: function ( eventObj ) {
          console.log( 'new event', eventObj);
          console.log( 'eventObj', eventObj.name, eventObj.properties)
          if ( this.get( 'newProp' ) ) {
            console.log('made it through', this.get( 'newProp' ) )
          }
          ractive.push( 'workingSpec.events', eventObj ).then( function() {
            console.log('pushed');
            ractive.set('newEvent', { name: "", properties: [] });
          });
        },
        addNewProp: function( prop ) {
          console.log('new prop', prop);
          ractive.push( 'newEvent.properties', prop);
          ractive.set( 'newProp', "" );
        },  
        /*saveSpec: function( input ) {
          console.log('workingSpec', input );
          console.log('time', new Date() );
        },*/
        filters: {
          user: function ( specItem ) { return specItem.user === ractive.get('selectedUser') },
          author: function( specItem ) { return specItem.user === ractive.get('author') }
        },
        computed: {
          selectedSpec: function () {
            return ractive.get( 'spec' ).filter(ractive.filters.user)[0];
          },
          authorSpec: function() {
            return ractive.get( 'spec' ).filter(ractive.filters.author)[0];
          }
        }
      })
/*
      ractive.on( 'addNewEvent', function ( event ) {
        event.original.preventDefault();
        console.log('this', this);
        this.addNewEvent( ractive.get( 'newEvent' ) );
      })
      */

      try {
        localStorage = window.localStorage;
      } catch (err) {}

      var author = ''
      if (localStorage) {
        author = localStorage.getItem('author') || ''
      }

      ractive.set('author', author);
      ractive.set('selectedUser', author);
      
      var proto = document.location.protocol;
      var setUrl = proto + "//api.mixpanel.com/engage";
      var getUrl = proto + "//mixpanel.com/api/2.0/engage";

      var distinct = "SPEC_USER";

      //A user must first input this project's token which will create the profile/database
      //setToken = function(projectToken) {
      //  token = $('input:text[name=token]').val();
      //  set({'token': projectToken})
      //}

      //pass this a list of spec objects
      set = function(data, token) {
        update = {
          "$set": data,
        }
        send(update, token);
      }
      
      append = function(data, token) {
        console.log('appending data', data);
        update = {
          "$append": data,
        } 
        send( update, token );
      }

      send = function( update, token ) {
        $.extend(update, {
          "$token": token,
          "$distinct_id": distinct
        })
        payload = { 'data': btoa(JSON.stringify(update)), "ip": 0 };
        console.log('set', payload)
        setXHR = new XMLHttpRequest();
        setXHR.open("POST", setUrl, true);
        setXHR.send($.param(payload))
      };

      //retrieve the user/database
      get = function() {
        return MP.api.query('/api/2.0/engage', {'distinct_id': distinct})
      }

      initialize = function( suppress_warning ) {
        /*
        token = (typeof token !== 'undefined') ? token : "";
        spec = (typeof spec !== 'undefined') ? spec : []
        console.log('initializing called', token, spec)
        */
        // initiate some spinning wheel thing saying that
        // Your Data is Loading

        // load a spec if it exists
        get().done(function(data){
          info = data.results[0]
          console.log('loading info', info)
          if (info) {
            console.log('info exists') //there is at least a token saved
            ractive.set( 'token', info.$properties.token );
            returnedSpec = info.$properties.spec || []
            console.log('returnedSpec', returnedSpec);
            if (!$.isEmptyObject(returnedSpec)) { //there's a spec saved too
              console.log('returnedSpec exists');
              returnedSpec.sort(function(a,b){
                return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
              });
              ractive.set('allSpecs', returnedSpec);
              ractive.set('workingSpec', returnedSpec[0]);
            } else { //prompt the user to make a new spec
              ractive.newSpec( ractive.get( 'author' ) );
              return;
            }
          } else {
            ractive.set('token', '');
            if (!suppress_warning) {
              alert('please re-enter your token');
            }
          }
        });
      }
 
      //initial page creation
      initialize( true )
      //MP.api.on('mpplatform.credentialsRegistered', initialize( true ))

      //for local testing
      //MP.api.trigger('mpplatform.credentialsRegistered');

    </script>

  </body>
</html>
