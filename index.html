<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="md5.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <h1>Hello, World!</h1>
    <form id="input">
      Project Token <input type="text" name="token">
      <input type="button" onclick="setToken();">
    </form>
    <script>
      var proto = document.location.protocol;
      var setUrl = proto + "//api.mixpanel.com/engage";
      var getUrl = proto + "//mixpanel.com/api/2.0/engage";

      token = new String();
      var distinct = "SPEC_USER";

      setToken = function() {
        token = $('input:text[name=token]').val();
        set({'token':token})
      }

      set = function(data) {
        update = {
          "$token": token,
          "$distinct_id": distinct,
          "$set": data,
          "$ignore_time": true
        }

        payload = { 'data': btoa(JSON.stringify(update)), "ip": 0 };

        setXHR = new XMLHttpRequest();
        setXHR.open("POST", setUrl, true);
        setXHR.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
        setXHR.send($.param(payload));
      };

      get = function() {

        getXHR = new XMLHttpRequest();

        var params = {
          'distinct_id': distinct,
          'expire': Math.round(new Date() / 1000) + 60,
          'api_key': MP.api.apiKey
        }

        var keys = Object.keys(params).sort();
        var sig = keys.map(function(key) {
            return "" + key + "=" + (params[key]);
        }).join("") + MP.api.apiSecret;
                        
        params.sig = md5(sig);

        getXHR.open("GET", getUrl+'?'+$.param(params), true)
        getXHR.send(null)
        
        console.log(getXHR.responseText)
      }

      get();
      debugger;

      console.log(MP.api.apiKey, MP.api.apiSecret)
      //set('nope');
    </script>
  </body>
</html>
